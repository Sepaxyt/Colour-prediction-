<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>53 Club - Admin Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Previous styles remain the same */
    </style>
</head>
<body>
    <div class="container">
        <!-- Header and sidebar remain the same -->
        
        <div class="main-content">
            <!-- Pending Approvals Section -->
            <div id="pending-approvals-section" class="content-section">
                <h2 class="section-title"><i class="fas fa-clock"></i> Pending Approvals</h2>
                
                <div class="table-container">
                    <table id="pending-approvals">
                        <thead>
                            <tr>
                                <th>Transaction ID</th>
                                <th>User Phone</th>
                                <th>Amount</th>
                                <th>UTR</th>
                                <th>Time</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Pending approvals will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Pending Withdrawals Section -->
            <div id="pending-withdrawals-section" class="content-section" style="display: none;">
                <h2 class="section-title"><i class="fas fa-money-bill-wave"></i> Pending Withdrawals</h2>
                
                <div class="table-container">
                    <table id="pending-withdrawals">
                        <thead>
                            <tr>
                                <th>Withdrawal ID</th>
                                <th>User Phone</th>
                                <th>Amount</th>
                                <th>Bank Details</th>
                                <th>Time</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Pending withdrawals will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Other sections remain the same -->
        </div>
    </div>
    
    <!-- Approval Modal -->
    <div class="modal" id="approval-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Approve Transaction</h3>
                <button class="close-modal" onclick="closeModal('approval-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Transaction ID</label>
                    <input type="text" id="approval-txn-id" readonly>
                </div>
                <div class="form-group">
                    <label>User Phone</label>
                    <input type="text" id="approval-user-phone" readonly>
                </div>
                <div class="form-group">
                    <label>Amount</label>
                    <input type="text" id="approval-amount" readonly>
                </div>
                <div class="form-group">
                    <label>UTR Number</label>
                    <input type="text" id="approval-utr" readonly>
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="approval-notes" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" onclick="closeModal('approval-modal')">Cancel</button>
                <button class="modal-btn modal-btn-primary" onclick="approveTransaction()">Approve</button>
            </div>
        </div>
    </div>
    
    <!-- Reject Modal -->
    <div class="modal" id="reject-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Reject Transaction</h3>
                <button class="close-modal" onclick="closeModal('reject-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Transaction ID</label>
                    <input type="text" id="reject-txn-id" readonly>
                </div>
                <div class="form-group">
                    <label>User Phone</label>
                    <input type="text" id="reject-user-phone" readonly>
                </div>
                <div class="form-group">
                    <label>Amount</label>
                    <input type="text" id="reject-amount" readonly>
                </div>
                <div class="form-group">
                    <label>Reason for Rejection</label>
                    <select id="reject-reason">
                        <option value="Invalid UTR">Invalid UTR</option>
                        <option value="Incorrect Amount">Incorrect Amount</option>
                        <option value="Fake Payment">Fake Payment</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group" id="reject-other-container" style="display: none;">
                    <label>Specify Reason</label>
                    <input type="text" id="reject-other-reason">
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="reject-notes" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" onclick="closeModal('reject-modal')">Cancel</button>
                <button class="modal-btn modal-btn-primary" onclick="rejectTransaction()">Confirm Rejection</button>
            </div>
        </div>
    </div>
    
    <!-- Withdrawal Approval Modal -->
    <div class="modal" id="withdrawal-approval-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Approve Withdrawal</h3>
                <button class="close-modal" onclick="closeModal('withdrawal-approval-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Withdrawal ID</label>
                    <input type="text" id="withdrawal-id" readonly>
                </div>
                <div class="form-group">
                    <label>User Phone</label>
                    <input type="text" id="withdrawal-user-phone" readonly>
                </div>
                <div class="form-group">
                    <label>Amount</label>
                    <input type="text" id="withdrawal-amount" readonly>
                </div>
                <div class="form-group">
                    <label>Bank Details</label>
                    <textarea id="withdrawal-bank-details" rows="4" readonly></textarea>
                </div>
                <div class="form-group">
                    <label>Transaction Reference</label>
                    <input type="text" id="withdrawal-reference" placeholder="Enter bank reference number">
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" onclick="closeModal('withdrawal-approval-modal')">Cancel</button>
                <button class="modal-btn modal-btn-primary" onclick="approveWithdrawal()">Approve</button>
            </div>
        </div>
    </div>
    
    <!-- Withdrawal Reject Modal -->
    <div class="modal" id="withdrawal-reject-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Reject Withdrawal</h3>
                <button class="close-modal" onclick="closeModal('withdrawal-reject-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Withdrawal ID</label>
                    <input type="text" id="reject-withdrawal-id" readonly>
                </div>
                <div class="form-group">
                    <label>User Phone</label>
                    <input type="text" id="reject-withdrawal-user" readonly>
                </div>
                <div class="form-group">
                    <label>Amount</label>
                    <input type="text" id="reject-withdrawal-amount" readonly>
                </div>
                <div class="form-group">
                    <label>Reason for Rejection</label>
                    <select id="withdrawal-reject-reason">
                        <option value="Insufficient Balance">Insufficient Balance</option>
                        <option value="Invalid Bank Details">Invalid Bank Details</option>
                        <option value="Suspicious Activity">Suspicious Activity</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group" id="withdrawal-reject-other-container" style="display: none;">
                    <label>Specify Reason</label>
                    <input type="text" id="withdrawal-reject-other-reason">
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" onclick="closeModal('withdrawal-reject-modal')">Cancel</button>
                <button class="modal-btn modal-btn-primary" onclick="rejectWithdrawal()">Confirm Rejection</button>
            </div>
        </div>
    </div>

    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyC5JqJPbyUw-rZgFp67nc0f5svWcoNt5D4",
            authDomain: "club-b8f03.firebaseapp.com",
            databaseURL: "https://club-b8f03-default-rtdb.firebaseio.com",
            projectId: "club-b8f03",
            storageBucket: "club-b8f03.firebasestorage.app",
            messagingSenderId: "115909846985",
            appId: "1:115909846985:web:6f42fbb224935c513cea18",
            measurementId: "G-S3M36PLB9Y"
        };
        
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        let currentAdmin = null;
        
        // Check if admin is logged in
        firebase.auth().onAuthStateChanged((user) => {
            if (user) {
                currentAdmin = user.uid;
                loadPendingApprovals();
                loadPendingWithdrawals();
            } else {
                window.location.href = "admin-login.html";
            }
        });
        
        // Load pending approvals
        function loadPendingApprovals() {
            database.ref('adminTransactions').orderByChild('status').equalTo('pending_approval').on('value', (snapshot) => {
                const tbody = document.querySelector('#pending-approvals tbody');
                tbody.innerHTML = '';
                
                snapshot.forEach((txnSnapshot) => {
                    const txnId = txnSnapshot.key;
                    const txn = txnSnapshot.val();
                    
                    const date = new Date(txn.timestamp);
                    const formattedDate = `${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')} ${date.getDate()}/${date.getMonth()+1}`;
                    
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${txnId}</td>
                        <td>${txn.userPhone}</td>
                        <td>₹${txn.amount.toLocaleString('en-IN')}</td>
                        <td>${txn.utr}</td>
                        <td>${formattedDate}</td>
                        <td>
                            <button class="action-btn approve-btn" onclick="openApprovalModal('${txnId}')">
                                <i class="fas fa-check"></i> Approve
                            </button>
                            <button class="action-btn reject-btn" onclick="openRejectModal('${txnId}')">
                                <i class="fas fa-times"></i> Reject
                            </button>
                        </td>
                    `;
                    
                    tbody.appendChild(tr);
                });
            });
        }
        
        // Load pending withdrawals
        function loadPendingWithdrawals() {
            database.ref('withdrawals').orderByChild('status').equalTo('pending').on('value', (snapshot) => {
                const tbody = document.querySelector('#pending-withdrawals tbody');
                tbody.innerHTML = '';
                
                snapshot.forEach((userSnapshot) => {
                    const userId = userSnapshot.key;
                    
                    userSnapshot.forEach((withdrawalSnapshot) => {
                        const withdrawalId = withdrawalSnapshot.key;
                        const withdrawal = withdrawalSnapshot.val();
                        
                        if (withdrawal.status === 'pending') {
                            const date = new Date(withdrawal.timestamp);
                            const formattedDate = `${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')} ${date.getDate()}/${date.getMonth()+1}`;
                            
                            const bankDetails = `
                                Bank: ${withdrawal.bankName}
                                A/C: ${withdrawal.accountNumber}
                                IFSC: ${withdrawal.ifscCode}
                                Name: ${withdrawal.accountName}
                            `;
                            
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td>${withdrawalId}</td>
                                <td>${userId}</td>
                                <td>₹${withdrawal.amount.toLocaleString('en-IN')}</td>
                                <td>${bankDetails}</td>
                                <td>${formattedDate}</td>
                                <td>
                                    <button class="action-btn approve-btn" onclick="openWithdrawalApprovalModal('${userId}', '${withdrawalId}')">
                                        <i class="fas fa-check"></i> Approve
                                    </button>
                                    <button class="action-btn reject-btn" onclick="openWithdrawalRejectModal('${userId}', '${withdrawalId}')">
                                        <i class="fas fa-times"></i> Reject
                                    </button>
                                </td>
                            `;
                            
                            tbody.appendChild(tr);
                        }
                    });
                });
            });
        }
        
        // Open approval modal
        function openApprovalModal(txnId) {
            database.ref(`adminTransactions/${txnId}`).once('value', (snapshot) => {
                const txn = snapshot.val();
                
                document.getElementById('approval-txn-id').value = txnId;
                document.getElementById('approval-user-phone').value = txn.userPhone;
                document.getElementById('approval-amount').value = `₹${txn.amount.toLocaleString('en-IN')}`;
                document.getElementById('approval-utr').value = txn.utr;
                document.getElementById('approval-notes').value = '';
                
                document.getElementById('approval-modal').style.display = 'flex';
            });
        }
        
        // Open reject modal
        function openRejectModal(txnId) {
            database.ref(`adminTransactions/${txnId}`).once('value', (snapshot) => {
                const txn = snapshot.val();
                
                document.getElementById('reject-txn-id').value = txnId;
                document.getElementById('reject-user-phone').value = txn.userPhone;
                document.getElementById('reject-amount').value = `₹${txn.amount.toLocaleString('en-IN')}`;
                document.getElementById('reject-reason').value = 'Invalid UTR';
                document.getElementById('reject-notes').value = '';
                
                document.getElementById('reject-modal').style.display = 'flex';
            });
        }
        
        // Open withdrawal approval modal
        function openWithdrawalApprovalModal(userId, withdrawalId) {
            database.ref(`withdrawals/${userId}/${withdrawalId}`).once('value', (snapshot) => {
                const withdrawal = snapshot.val();
                
                document.getElementById('withdrawal-id').value = withdrawalId;
                document.getElementById('withdrawal-user-phone').value = userId;
                document.getElementById('withdrawal-amount').value = `₹${withdrawal.amount.toLocaleString('en-IN')}`;
                
                const bankDetails = `Bank: ${withdrawal.bankName}\nAccount: ${withdrawal.accountNumber}\nIFSC: ${withdrawal.ifscCode}\nName: ${withdrawal.accountName}`;
                document.getElementById('withdrawal-bank-details').value = bankDetails;
                document.getElementById('withdrawal-reference').value = '';
                
                document.getElementById('withdrawal-approval-modal').style.display = 'flex';
            });
        }
        
        // Open withdrawal reject modal
        function openWithdrawalRejectModal(userId, withdrawalId) {
            database.ref(`withdrawals/${userId}/${withdrawalId}`).once('value', (snapshot) => {
                const withdrawal = snapshot.val();
                
                document.getElementById('reject-withdrawal-id').value = withdrawalId;
                document.getElementById('reject-withdrawal-user').value = userId;
                document.getElementById('reject-withdrawal-amount').value = `₹${withdrawal.amount.toLocaleString('en-IN')}`;
                document.getElementById('withdrawal-reject-reason').value = 'Insufficient Balance';
                
                document.getElementById('withdrawal-reject-modal').style.display = 'flex';
            });
        }
        
        // Approve transaction
        function approveTransaction() {
            const txnId = document.getElementById('approval-txn-id').value;
            const userPhone = document.getElementById('approval-user-phone').value;
            const amount = parseInt(document.getElementById('approval-amount').value.replace('₹', '').replace(/,/g, ''));
            const notes = document.getElementById('approval-notes').value;
            
            // Update transaction status
            database.ref(`adminTransactions/${txnId}`).update({
                status: 'approved',
                approvedBy: currentAdmin,
                approvedAt: Date.now(),
                notes: notes
            }).then(() => {
                // Also update in user's deposits
                database.ref(`deposits/${userPhone}/${txnId}`).update({
                    status: 'success',
                    verifiedAt: Date.now()
                }).then(() => {
                    // Update user balance
                    database.ref(`users/${userPhone}/balance`).transaction((balance) => {
                        return (balance || 0) + amount;
                    }).then(() => {
                        // Create user notification
                        createUserNotification(
                            userPhone,
                            'Deposit Approved',
                            `Your deposit of ₹${amount} has been approved and credited to your account.`,
                            'success'
                        );
                        
                        showToast('Transaction approved successfully!', 'success');
                        closeModal('approval-modal');
                    });
                });
            });
        }
        
        // Reject transaction
        function rejectTransaction() {
            const txnId = document.getElementById('reject-txn-id').value;
            const userPhone = document.getElementById('reject-user-phone').value;
            const amount = parseInt(document.getElementById('reject-amount').value.replace('₹', '').replace(/,/g, ''));
            
            let rejectReason = document.getElementById('reject-reason').value;
            if (rejectReason === 'Other') {
                rejectReason = document.getElementById('reject-other-reason').value;
            }
            
            const notes = document.getElementById('reject-notes').value;
            
            // Update transaction status
            database.ref(`adminTransactions/${txnId}`).update({
                status: 'rejected',
                rejectedBy: currentAdmin,
                rejectedAt: Date.now(),
                rejectReason: rejectReason,
                notes: notes
            }).then(() => {
                // Also update in user's deposits
                database.ref(`deposits/${userPhone}/${txnId}`).update({
                    status: 'failed',
                    rejectedAt: Date.now(),
                    rejectReason: rejectReason
                }).then(() => {
                    // Create user notification
                    createUserNotification(
                        userPhone,
                        'Deposit Rejected',
                        `Your deposit of ₹${amount} has been rejected. Reason: ${rejectReason}`,
                        'error'
                    );
                    
                    showToast('Transaction rejected successfully!', 'success');
                    closeModal('reject-modal');
                });
            });
        }
        
        // Approve withdrawal
        function approveWithdrawal() {
            const withdrawalId = document.getElementById('withdrawal-id').value;
            const userPhone = document.getElementById('withdrawal-user-phone').value;
            const amount = parseInt(document.getElementById('withdrawal-amount').value.replace('₹', '').replace(/,/g, ''));
            const reference = document.getElementById('withdrawal-reference').value;
            
            if (!reference) {
                showToast('Please enter a reference number', 'error');
                return;
            }
            
            // Update withdrawal status
            database.ref(`withdrawals/${userPhone}/${withdrawalId}`).update({
                status: 'completed',
                completedAt: Date.now(),
                approvedBy: currentAdmin,
                referenceNumber: reference
            }).then(() => {
                // Create user notification
                createUserNotification(
                    userPhone,
                    'Withdrawal Approved',
                    `Your withdrawal request of ₹${amount} has been approved. Reference: ${reference}`,
                    'success'
                );
                
                showToast('Withdrawal approved successfully!', 'success');
                closeModal('withdrawal-approval-modal');
            });
        }
        
        // Reject withdrawal
        function rejectWithdrawal() {
            const withdrawalId = document.getElementById('reject-withdrawal-id').value;
            const userPhone = document.getElementById('reject-withdrawal-user').value;
            const amount = parseInt(document.getElementById('reject-withdrawal-amount').value.replace('₹', '').replace(/,/g, ''));
            
            let rejectReason = document.getElementById('withdrawal-reject-reason').value;
            if (rejectReason === 'Other') {
                rejectReason = document.getElementById('withdrawal-reject-other-reason').value;
            }
            
            // Update withdrawal status
            database.ref(`withdrawals/${userPhone}/${withdrawalId}`).update({
                status: 'rejected',
                rejectedAt: Date.now(),
                rejectReason: rejectReason
            }).then(() => {
                // Return funds to user balance
                database.ref(`users/${userPhone}/balance`).transaction((balance) => {
                    return (balance || 0) + amount;
                }).then(() => {
                    // Create user notification
                    createUserNotification(
                        userPhone,
                        'Withdrawal Rejected',
                        `Your withdrawal request of ₹${amount} has been rejected. Reason: ${rejectReason}. Amount has been returned to your balance.`,
                        'error'
                    );
                    
                    showToast('Withdrawal rejected successfully!', 'success');
                    closeModal('withdrawal-reject-modal');
                });
            });
        }
        
        // Create user notification
        function createUserNotification(userPhone, title, message, type) {
            const notificationId = 'NOT' + Date.now();
            
            database.ref(`notifications/${userPhone}/${notificationId}`).set({
                title: title,
                message: message,
                type: type,
                timestamp: Date.now(),
                read: false
            });
        }
        
        // Close modal
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        // Show toast notification
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span class="toast-icon">${type === 'success' ? '✓' : type === 'error' ? '✗' : type === 'warning' ? '⚠' : 'i'}</span>
                ${message}
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
        
        // Event listeners for reason selection
        document.getElementById('reject-reason').addEventListener('change', function() {
            if (this.value === 'Other') {
                document.getElementById('reject-other-container').style.display = 'block';
            } else {
                document.getElementById('reject-other-container').style.display = 'none';
            }
        });
        
        document.getElementById('withdrawal-reject-reason').addEventListener('change', function() {
            if (this.value === 'Other') {
                document.getElementById('withdrawal-reject-other-container').style.display = 'block';
            } else {
                document.getElementById('withdrawal-reject-other-container').style.display = 'none';
            }
        });
    </script>
</body>
</html>
