<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>53 Club - Withdraw</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        
        :root {
            --primary: #6a11cb;
            --secondary: #4a6bff;
            --dark: #121212;
            --light: #f8f9fa;
            --gray: #6c757d;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --info: #17a2b8;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, var(--dark), #1a1a1a);
            color: var(--light);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
        }
        
        .logo {
            display: flex;
            align-items: center;
        }
        
        .logo-img {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--secondary), var(--primary));
            border-radius: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
            margin-right: 10px;
        }
        
        .logo h1 {
            font-size: 1.5rem;
            background: linear-gradient(to right, var(--secondary), var(--primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .back-btn {
            color: var(--light);
            text-decoration: none;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
        }
        
        .back-btn i {
            margin-right: 5px;
        }
        
        .wallet-container {
            display: flex;
            flex-direction: column;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .balance-card {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }
        
        .balance-title {
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 5px;
        }
        
        .balance-amount {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 15px;
        }
        
        .withdraw-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .section-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }
        
        .section-title i {
            margin-right: 10px;
            color: var(--secondary);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: var(--light);
            font-size: 1rem;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--secondary);
        }
        
        .amount-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .amount-btn {
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: var(--light);
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .amount-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .amount-btn.active {
            background: var(--secondary);
            color: white;
            border-color: var(--secondary);
        }
        
        .bank-details {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px dashed rgba(255, 255, 255, 0.1);
        }
        
        .bank-item {
            margin-bottom: 10px;
        }
        
        .bank-name {
            font-weight: 500;
        }
        
        .bank-info {
            font-size: 0.9rem;
            color: var(--gray);
        }
        
        .add-bank-btn {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px dashed rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            color: var(--light);
            text-align: center;
            cursor: pointer;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }
        
        .add-bank-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--secondary);
        }
        
        .add-bank-btn i {
            margin-right: 8px;
        }
        
        .submit-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(to right, var(--secondary), var(--primary));
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .submit-btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        .submit-btn:disabled {
            background: var(--gray);
            cursor: not-allowed;
            transform: none;
        }
        
        .history-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
        }
        
        .history-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .history-amount {
            font-weight: 500;
        }
        
        .history-success {
            color: var(--success);
        }
        
        .history-pending {
            color: var(--warning);
        }
        
        .history-failed {
            color: var(--danger);
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: linear-gradient(135deg, var(--dark), #1a1a1a);
            border-radius: 12px;
            padding: 25px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }
        
        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 1.5rem;
            color: var(--gray);
            cursor: pointer;
        }
        
        .modal-title {
            font-size: 1.3rem;
            margin-bottom: 20px;
            color: var(--light);
        }
        
        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--success);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1001;
            display: flex;
            align-items: center;
            animation: toastFadeIn 0.3s ease, toastFadeOut 0.3s ease 2.7s forwards;
        }
        
        @keyframes toastFadeIn {
            from { opacity: 0; transform: translateX(-50%) translateY(20px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }
        
        @keyframes toastFadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        .toast.error {
            background-color: var(--danger);
        }
        
        .toast.warning {
            background-color: var(--warning);
            color: var(--dark);
        }
        
        .toast.info {
            background-color: var(--info);
        }
        
        .toast-icon {
            margin-right: 10px;
            font-size: 1.2rem;
        }
        
        /* Loading Spinner */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Responsive styles */
        @media (max-width: 768px) {
            .amount-buttons {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <a href="main.html" class="back-btn">
                <i class="fas fa-arrow-left"></i> Back
            </a>
            
            <div class="logo">
                <div class="logo-img">53</div>
                <h1>53 Club</h1>
            </div>
            
            <div style="width: 60px;"> <!-- Spacer for alignment --> </div>
        </header>
        
        <div class="wallet-container">
            <div class="balance-card">
                <div class="balance-title">Your Current Balance</div>
                <div class="balance-amount" id="current-balance">₹0.00</div>
            </div>
            
            <div class="withdraw-section">
                <h3 class="section-title"><i class="fas fa-money-bill-wave"></i> Withdraw Funds</h3>
                
                <div class="form-group">
                    <label class="form-label">Withdraw Amount (₹)</label>
                    <input type="number" class="form-control" id="withdraw-amount" placeholder="Enter amount (min ₹100)" min="100">
                </div>
                
                <div class="amount-buttons">
                    <div class="amount-btn" onclick="setAmount(100)">₹100</div>
                    <div class="amount-btn" onclick="setAmount(500)">₹500</div>
                    <div class="amount-btn" onclick="setAmount(1000)">₹1000</div>
                    <div class="amount-btn" onclick="setAmount(2000)">₹2000</div>
                    <div class="amount-btn" onclick="setAmount(5000)">₹5000</div>
                    <div class="amount-btn" onclick="setAmount(10000)">₹10000</div>
                </div>
                
                <div id="bank-container">
                    <!-- Bank details will be loaded here -->
                </div>
                
                <button class="add-bank-btn" onclick="showAddBankModal()">
                    <i class="fas fa-plus"></i> Add New Bank Account
                </button>
                
                <button class="submit-btn" id="withdraw-btn" onclick="processWithdrawal()">
                    Request Withdrawal
                </button>
            </div>
            
            <div class="history-section">
                <h3 class="section-title"><i class="fas fa-history"></i> Withdrawal History</h3>
                
                <div id="withdrawal-history">
                    <!-- History items will be loaded here -->
                    <div class="history-item">
                        <div class="history-date">No withdrawals yet</div>
                        <div class="history-amount history-pending">₹0.00</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add Bank Modal -->
    <div class="modal" id="bank-modal">
        <div class="modal-content">
            <span class="close-modal" onclick="hideAddBankModal()">&times;</span>
            <h3 class="modal-title">Add Bank Account</h3>
            
            <div class="form-group">
                <label class="form-label">Select Bank</label>
                <select class="form-control" id="bank-name">
                    <option value="">Select your bank</option>
                    <!-- Indian banks will be loaded here -->
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Account Holder Name</label>
                <input type="text" class="form-control" id="account-name" placeholder="As per bank records">
            </div>
            
            <div class="form-group">
                <label class="form-label">Account Number</label>
                <input type="text" class="form-control" id="account-number" placeholder="Enter account number">
            </div>
            
            <div class="form-group">
                <label class="form-label">IFSC Code</label>
                <input type="text" class="form-control" id="ifsc-code" placeholder="Enter IFSC code">
            </div>
            
            <div class="form-group">
                <label class="form-label">Account Type</label>
                <select class="form-control" id="account-type">
                    <option value="savings">Savings Account</option>
                    <option value="current">Current Account</option>
                    <option value="salary">Salary Account</option>
                </select>
            </div>
            
            <button class="submit-btn" onclick="saveBankDetails()">
                Save Bank Details
            </button>
        </div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyC5JqJPbyUw-rZgFp67nc0f5svWcoNt5D4",
            authDomain: "club-b8f03.firebaseapp.com",
            databaseURL: "https://club-b8f03-default-rtdb.firebaseio.com",
            projectId: "club-b8f03",
            storageBucket: "club-b8f03.firebasestorage.app",
            messagingSenderId: "115909846985",
            appId: "1:115909846985:web:6f42fbb224935c513cea18",
            measurementId: "G-S3M36PLB9Y"
        };
        
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // List of major Indian banks
        const indianBanks = [
            "State Bank of India",
            "HDFC Bank",
            "ICICI Bank",
            "Axis Bank",
            "Punjab National Bank",
            "Bank of Baroda",
            "Canara Bank",
            "Union Bank of India",
            "Bank of India",
            "Indian Bank",
            "Central Bank of India",
            "IDBI Bank",
            "Kotak Mahindra Bank",
            "IndusInd Bank",
            "Yes Bank",
            "Federal Bank",
            "RBL Bank",
            "Bandhan Bank",
            "IDFC First Bank",
            "South Indian Bank"
        ];
        
        // Check if user is logged in
        const userPhone = localStorage.getItem('userPhone') || sessionStorage.getItem('userPhone');
        if(!userPhone) {
            window.location.href = "index.html";
        } else {
            // Load user balance
            loadBalance();
            
            // Load bank details
            loadBankDetails();
            
            // Load withdrawal history
            loadWithdrawalHistory();
            
            // Populate bank dropdown
            populateBankDropdown();
        }
        
        // Load user balance
        function loadBalance() {
            database.ref('users/' + userPhone + '/balance').on('value', (snapshot) => {
                const balance = snapshot.val() || 0;
                document.getElementById('current-balance').textContent = 
                    '₹' + balance.toLocaleString('en-IN', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    });
            });
        }
        
        // Load bank details
        function loadBankDetails() {
            database.ref('bankAccounts/' + userPhone).on('value', (snapshot) => {
                const banks = snapshot.val();
                const bankContainer = document.getElementById('bank-container');
                
                if(banks) {
                    bankContainer.innerHTML = '';
                    
                    Object.entries(banks).forEach(([bankId, bank]) => {
                        const bankItem = document.createElement('div');
                        bankItem.className = 'bank-details';
                        bankItem.innerHTML = `
                            <div class="bank-item">
                                <input type="radio" name="selectedBank" id="bank-${bankId}" value="${bankId}" ${bank.isDefault ? 'checked' : ''}>
                                <label for="bank-${bankId}">
                                    <div class="bank-name">${bank.bankName}</div>
                                    <div class="bank-info">A/C: ${bank.accountNumber} | IFSC: ${bank.ifscCode}</div>
                                    <div class="bank-info">${bank.accountName} (${bank.accountType})</div>
                                </label>
                            </div>
                        `;
                        bankContainer.appendChild(bankItem);
                    });
                } else {
                    bankContainer.innerHTML = '<p style="color: var(--gray); text-align: center;">No bank accounts added yet</p>';
                }
            });
        }
        
        // Load withdrawal history
        function loadWithdrawalHistory() {
            database.ref('withdrawals/' + userPhone).orderByChild('timestamp').limitToLast(5).on('value', (snapshot) => {
                const withdrawals = snapshot.val();
                const historyContainer = document.getElementById('withdrawal-history');
                
                if(withdrawals) {
                    historyContainer.innerHTML = '';
                    
                    // Convert to array and reverse to show newest first
                    const withdrawalsArray = Object.entries(withdrawals).reverse();
                    
                    withdrawalsArray.forEach(([key, withdrawal]) => {
                        const historyItem = document.createElement('div');
                        historyItem.className = 'history-item';
                        
                        const date = new Date(withdrawal.timestamp);
                        const formattedDate = `${date.getDate()}/${date.getMonth()+1}/${date.getFullYear()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
                        
                        let statusClass = 'history-pending';
                        if(withdrawal.status === 'success') statusClass = 'history-success';
                        if(withdrawal.status === 'failed') statusClass = 'history-failed';
                        
                        historyItem.innerHTML = `
                            <div class="history-date">${formattedDate}</div>
                            <div class="history-amount ${statusClass}">
                                ₹${withdrawal.amount.toLocaleString('en-IN')}
                            </div>
                        `;
                        
                        historyContainer.appendChild(historyItem);
                    });
                } else {
                    historyContainer.innerHTML = `
                        <div class="history-item">
                            <div class="history-date">No withdrawals yet</div>
                            <div class="history-amount history-pending">₹0.00</div>
                        </div>
                    `;
                }
            });
        }
        
        // Populate bank dropdown
        function populateBankDropdown() {
            const bankSelect = document.getElementById('bank-name');
            indianBanks.forEach(bank => {
                const option = document.createElement('option');
                option.value = bank;
                option.textContent = bank;
                bankSelect.appendChild(option);
            });
        }
        
        // Set amount from quick buttons
        function setAmount(amount) {
            document.getElementById('withdraw-amount').value = amount;
            
            // Highlight the selected button
            document.querySelectorAll('.amount-btn').forEach(btn => {
                btn.classList.remove('active');
                if(parseInt(btn.textContent.replace('₹', '')) === amount) {
                    btn.classList.add('active');
                }
            });
        }
        
        // Show add bank modal
        function showAddBankModal() {
            document.getElementById('bank-modal').style.display = 'flex';
        }
        
        // Hide add bank modal
        function hideAddBankModal() {
            document.getElementById('bank-modal').style.display = 'none';
        }
        
        // Save bank details
        function saveBankDetails() {
            const bankName = document.getElementById('bank-name').value;
            const accountName = document.getElementById('account-name').value;
            const accountNumber = document.getElementById('account-number').value;
            const ifscCode = document.getElementById('ifsc-code').value;
            const accountType = document.getElementById('account-type').value;
            
            if(!bankName || !accountName || !accountNumber || !ifscCode) {
                showToast('Please fill all bank details', 'error');
                return;
            }
            
            // Validate account number (basic validation)
            if(!/^\d{9,18}$/.test(accountNumber)) {
                showToast('Please enter a valid account number (9-18 digits)', 'error');
                return;
            }
            
            // Validate IFSC code (basic validation)
            if(!/^[A-Za-z]{4}0[A-Za-z0-9]{6}$/.test(ifscCode)) {
                showToast('Please enter a valid IFSC code', 'error');
                return;
            }
            
            // Check if this bank account already exists
            database.ref('bankAccounts/' + userPhone).once('value').then((snapshot) => {
                const banks = snapshot.val() || {};
                const accountExists = Object.values(banks).some(bank => 
                    bank.bankName === bankName && 
                    bank.accountNumber === accountNumber
                );
                
                if(accountExists) {
                    showToast('This bank account is already added', 'error');
                    return;
                }
                
                // Save new bank account
                const bankId = 'bank_' + Date.now();
                const bankData = {
                    bankName: bankName,
                    accountName: accountName,
                    accountNumber: accountNumber,
                    ifscCode: ifscCode.toUpperCase(),
                    accountType: accountType,
                    isDefault: Object.keys(banks).length === 0, // Set as default if first account
                    addedAt: Date.now()
                };
                
                database.ref('bankAccounts/' + userPhone + '/' + bankId).set(bankData)
                    .then(() => {
                        showToast('Bank account added successfully', 'success');
                        hideAddBankModal();
                        
                        // Clear form
                        document.getElementById('account-name').value = '';
                        document.getElementById('account-number').value = '';
                        document.getElementById('ifsc-code').value = '';
                    })
                    .catch((error) => {
                        console.error('Error saving bank details:', error);
                        showToast('Error saving bank details', 'error');
                    });
            });
        }
        
        // Process withdrawal
        function processWithdrawal() {
            const amount = parseInt(document.getElementById('withdraw-amount').value);
            const selectedBank = document.querySelector('input[name="selectedBank"]:checked');
            
            if(!amount || amount < 100) {
                showToast('Minimum withdrawal amount is ₹100', 'error');
                return;
            }
            
            if(!selectedBank) {
                showToast('Please select a bank account', 'error');
                return;
            }
            
            // Check if user has sufficient balance
            database.ref('users/' + userPhone + '/balance').once('value').then((snapshot) => {
                const balance = snapshot.val() || 0;
                
                if(amount > balance) {
                    showToast('Insufficient balance for withdrawal', 'error');
                    return;
                }
                
                const btn = document.getElementById('withdraw-btn');
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner"></span> Processing...';
                
                // Generate a random transaction ID
                const transactionId = 'WDR' + Date.now() + Math.floor(Math.random() * 1000);
                
                // Get bank details
                database.ref('bankAccounts/' + userPhone + '/' + selectedBank.value).once('value').then((bankSnapshot) => {
                    const bankDetails = bankSnapshot.val();
                    
                    // Create withdrawal record
                    const withdrawalData = {
                        amount: amount,
                        bankId: selectedBank.value,
                        bankName: bankDetails.bankName,
                        accountNumber: bankDetails.accountNumber,
                        ifscCode: bankDetails.ifscCode,
                        status: 'pending',
                        timestamp: Date.now()
                    };
                    
                    // Save to Firebase
                    database.ref('withdrawals/' + userPhone + '/' + transactionId).set(withdrawalData)
                        .then(() => {
                            // Send notification to admin
                            database.ref('adminNotifications').push({
                                type: 'withdrawal',
                                userId: userPhone,
                                transactionId: transactionId,
                                amount: amount,
                                bankDetails: bankDetails,
                                status: 'pending',
                                timestamp: Date.now(),
                                read: false
                            });
                            
                            // Create notification for user
                            createNotification(
                                'Withdrawal Requested',
                                `Your withdrawal request of ₹${amount} has been submitted for processing.`,
                                'info'
                            );
                            
                            showToast(`Withdrawal of ₹${amount} requested successfully!`, 'success');
                            
                            // Reset form
                            document.getElementById('withdraw-amount').value = '';
                            btn.disabled = false;
                            btn.textContent = 'Request Withdrawal';
                        })
                        .catch((error) => {
                            console.error('Error processing withdrawal:', error);
                            showToast('Error processing withdrawal. Please try again.', 'error');
                            btn.disabled = false;
                            btn.textContent = 'Request Withdrawal';
                        });
                });
            });
        }
        
        // Create notification
        function createNotification(title, message, type) {
            const notificationId = 'NOT' + Date.now();
            
            database.ref('notifications/' + userPhone + '/' + notificationId).set({
                title: title,
                message: message,
                type: type,
                timestamp: Date.now(),
                read: false
            });
        }
        
        // Show toast notification
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span class="toast-icon">${type === 'success' ? '✓' : type === 'error' ? '✗' : type === 'warning' ? '⚠' : 'i'}</span>
                ${message}
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
    </script>
</body>
</html>
